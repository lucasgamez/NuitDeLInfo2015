<html>

	<head>
		<title>Jeu Star wars Arcade</title>
		<style>
			body {
				margin: 0;
				padding: 0;
				background-color: #123456;
			}
		</style>
		<script src="phaser.js"></script>
	</head>

	<body>
	<div id="test" align="center">

		<script>
			var start = false;
			//force du bien
			var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
			var chemin = "Shooter2/v4_clair/";
			

			function preload() {
				game.load.image('player', chemin+'ship.png');
				game.load.image('back', chemin+'1.jpg');
				game.load.image('mid', chemin+'2.jpg');
				game.load.image('top', chemin+'3.jpg');
				game.load.image('asteroide', chemin+'asteroide.png');
				game.load.image('balle',chemin+'tir.jpg');
				game.load.image('ennemi',chemin+'vaisseau1.png');
				game.load.image('over',chemin+'GameOverBlue.png');
				game.load.image('win',chemin+'YouWinBlue.png');

			}

			var cursors;
			var currentSpeed = 0;

			var parallaxback = [];
			var parallaxmid = [];
			var parallaxtop = [];
			

			var asteroide = [];
			var asteoX = 110;
			var asteoY = 113;
			var sprite;
			var balle = [];
			var tir;

			var ennemi = [];
			var direction = [];

			var nbTir = 0;
			var autorisation = true; //bool

			var vague = 3;
			var nbEnnemi = 5;

			var move = true;

			function create() {

				initPara();
				initAsteo();
				
				game.time.events.add(Phaser.Timer.SECOND * 10, firstSpawn, this);

			    //  This will run in Canvas mode, so let's gain a little speed and display
				game.renderer.clearBeforeRender = false;
    			game.renderer.roundPixels = true;

    			//  We need arcade physics
    			game.physics.startSystem(Phaser.Physics.ARCADE);
				
				//  Our player ship
				sprite = game.add.sprite(300, 300, 'player');
				sprite.anchor.set(0.5);


				//  and its physics settings
				game.physics.enable(sprite, Phaser.Physics.ARCADE);

				sprite.body.drag.set(100);
				
				sprite.body.maxVelocity.set(200);

				//  Game input
				cursors = game.input.keyboard.createCursorKeys();
				tir = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);



				cursors = game.input.keyboard.createCursorKeys();
			}

			function update() {

			    if(start){

				if (cursors.left.isDown && move)
					{
						//deplacementPara(currentSpeed);
						
						sprite.angle -= 4;
						//console.log(sprite.angle);
					}
					else if (cursors.right.isDown && move)
					{
						//deplacementPara(currentSpeed);
						sprite.angle += 4;
						//console.log(sprite.angle);
					}if (tir.isDown && autorisation == true && move){
						//console.log("test " + nbTir);
						if(nbTir <= 10){
							tirB();
						}else{
							autorisation = false; //interdiction de tirer
							nbTir = 0;
							game.time.events.add(Phaser.Timer.SECOND * 0.3, autoriser, this);
						}
					}

					if (cursors.up.isDown && move)
					{
						//  The speed we'll travel at
						//deplacementPara(currentSpeed);
						currentSpeed = 300;
					}
					else
					{
						if (currentSpeed > 0)
						{
							currentSpeed -= 4;
						}
					}

					if (currentSpeed > 0)
					{
						//deplacementPara(currentSpeed);
						game.physics.arcade.velocityFromRotation(sprite.rotation, currentSpeed, sprite.body.velocity);
						
					}

				screenWrap(sprite);
				tuerBalle();
				mortJoueur();
				game.physics.arcade.collide(sprite, asteroide[0]);
				game.physics.arcade.collide(sprite, asteroide[1]);
				game.physics.arcade.collide(sprite, asteroide[2]);
				game.physics.arcade.collide(sprite, asteroide[3]);

				if(nbEnnemi <= 0 && vague > 0){ //refaire spawn les ennemi
					spawn_ennemi(5);
					nbEnnemi = 5;
					vague -= 1;
				}

				if(vague <= 0){
					//vous avez gagné
					//console.log("win!");
					game.add.sprite(0,0, 'win');
					move = false;
					game.time.events.add(Phaser.Timer.SECOND * 3, restart, this);
					
				}
				
				for(var i = 0 ; i < ennemi.length ; i++){
					game.physics.arcade.collide(sprite, ennemi[i]);
					screenWrap(ennemi[i]);
				}
				
				//collision
				for(var i = 0 ; i < balle.length ; i++){
					for(var j = 0 ; j < ennemi.length ; j++){
						if(balle[i] != -1){
							game.physics.arcade.collide(ennemi[j], balle[i]);
							/*if(balle[i].x > ennemi[j].x+50 && balle[i].x < ennemi[j].x && balle[i].y > ennemi[j].y+50 && balle[i].y < ennemi[j].y){
								tuerEnnemi(i,j);
							}*/
						}
					}
				}

			ennemi_move();

			  }
				
			}



			
			function autoriser(){//autoriser de tirer
				autorisation = true;
			}

			function initAsteo(){
			
				var pos_x = Math.floor((Math.random() * 400-asteoX) + asteoX)/2;
				var pos_y = Math.floor((Math.random() * 300-asteoX) + asteoX)/2;
				
				var pos_x1 = Math.floor((Math.random() * 800-asteoX) + 400+asteoX)/1.75;
				var pos_y1 = Math.floor((Math.random() * 300-asteoX) + asteoX)/1.75;
				
				var pos_x2 = Math.floor((Math.random() * 400-asteoX) + asteoX)/2;
				var pos_y2 = Math.floor((Math.random() * 600-asteoX) + 300+asteoX)/2;
				
				var pos_x3 = Math.floor((Math.random() * 800-asteoX) + 400+asteoX)/1.75;
				var pos_y3 = Math.floor((Math.random() * 600-asteoX) + 300+asteoX)/1.75;

				asteroide.push(game.add.sprite(pos_x,pos_y,'asteroide'));
				asteroide.push(game.add.sprite(pos_x1,pos_y1,'asteroide'));
				asteroide.push(game.add.sprite(pos_x2,pos_y2,'asteroide'));
				asteroide.push(game.add.sprite(pos_x3,pos_y3,'asteroide'));

				game.physics.enable(asteroide[0], Phaser.Physics.ARCADE); //active la physique
				game.physics.enable(asteroide[1], Phaser.Physics.ARCADE);
				game.physics.enable(asteroide[2], Phaser.Physics.ARCADE);
				game.physics.enable(asteroide[3], Phaser.Physics.ARCADE);

				asteroide[0].body.immovable = true; //ne bouge pas
				asteroide[1].body.immovable = true;
				asteroide[2].body.immovable = true;
				asteroide[3].body.immovable = true;
		

			}



			function ennemi_move()
			{
				for(var i = 0 ; i < ennemi.length ; i++)
				{
					if(sprite.x <= ennemi[i].x && sprite.y <= ennemi[i].y )
					{
						ennemi[i].x -= 1;
						ennemi[i].y -= 1;
					}
					if(sprite.x >= ennemi[i].x && sprite.y <= ennemi[i].y )
					{
						ennemi[i].x += 1;
						ennemi[i].y -= 1;
					}
					if(sprite.x >= ennemi[i].x && sprite.y >= ennemi[i].y )
					{
						ennemi[i].x += 1;
						ennemi[i].y += 1;
					}
					if(sprite.x <= ennemi[i].x && sprite.y >= ennemi[i].y )
					{
						ennemi[i].x -= 1;
						ennemi[i].y += 1;
					}	
				}
			}


			function spawn_ennemi(nbennemi){

					for(var i = 0;i<nbennemi;i++)
					{
						var nbspawn = Math.floor((Math.random() * 4) + 1);
						if (nbspawn==1)
						{
							var pos_x = Math.floor((Math.random() * 400-asteoX) + asteoX)/2;
							var pos_y = Math.floor((Math.random() * 300-asteoX) + asteoX)/2;
							ennemi.push(game.add.sprite(pos_x,pos_y,'ennemi'));	
							game.physics.enable(ennemi[ennemi.length-1], Phaser.Physics.ARCADE);	
							ennemi[ennemi.length-1].body.maxVelocity.set(200);
							//game.physics.arcade.collide(sprite, ennemi[ennemi.length-1]);		
					
						}
						if (nbspawn==2)
						{
							var pos_x1 = Math.floor((Math.random() * 800-asteoX) + 400+asteoX)/1.75;
							var pos_y1 = Math.floor((Math.random() * 300-asteoX) + asteoX)/1.75;
							ennemi.push(game.add.sprite(pos_x1,pos_y1,'ennemi'));
							game.physics.enable(ennemi[ennemi.length-1], Phaser.Physics.ARCADE);
							ennemi[ennemi.length-1].body.maxVelocity.set(200);
							//game.physics.arcade.collide(sprite, ennemi[ennemi.length-1]);	
						}
				
						if(nbspawn==3)
						{
							var pos_x2 = Math.floor((Math.random() * 400-asteoX) + asteoX)/2;
							var pos_y2 = Math.floor((Math.random() * 600-asteoX) + 300+asteoX)/2;
							ennemi.push(game.add.sprite(pos_x2,pos_y2,'ennemi'));
							game.physics.enable(ennemi[ennemi.length-1], Phaser.Physics.ARCADE);
							ennemi[ennemi.length-1].body.maxVelocity.set(200);
							//game.physics.arcade.collide(sprite, ennemi[ennemi.length-1]);
						}
						if(nbspawn==4)
						{
							var pos_x3 = Math.floor((Math.random() * 800-asteoX) + 400+asteoX)/1.75;
							var pos_y3 = Math.floor((Math.random() * 600-asteoX) + 300+asteoX)/1.75;
							ennemi.push(game.add.sprite(pos_x3,pos_y3,'ennemi'));
							game.physics.enable(ennemi[ennemi.length-1], Phaser.Physics.ARCADE);
							ennemi[ennemi.length-1].body.maxVelocity.set(200);
							//game.physics.arcade.collide(sprite, ennemi[ennemi.length-1]);	
						}
					}
					//game.physics.enable(asteroide[0], Phaser.Physics.ARCADE);
					//game.physics.enable(asteroide[1], Phaser.Physics.ARCADE);
					//game.physics.enable(asteroide[2], Phaser.Physics.ARCADE);
					//game.physics.enable(asteroide[3], Phaser.Physics.ARCADE);
				

				
			}
			
			/*function tuerEnnemi(i,j){
				balle[i].kill();
				balle[i] = -1;

				ennemi[j].kill();
				ennemi[j] = -1;
				
				console.log(i + " balle, " + j + " ennemi.");

			}*/

			function firstSpawn(){
				spawn_ennemi(5);
			}

			function screenWrap(sprite) {

				if (sprite.x < 0)
				{
					sprite.x = game.width;
				}
				else if (sprite.x > game.width)
				{
					sprite.x = 0;
				}

				if (sprite.y < 0)
				{
					sprite.y = game.height;
				}
				else if (sprite.y > game.height)
				{
					sprite.y = 0;
				}

			}

			function tirB(){ //tire une balle
				balle.push(game.add.sprite(sprite.x, sprite.y, 'balle'));
				var last = balle.length-1;
				game.physics.enable(balle[last], Phaser.Physics.ARCADE);
				//console.log(last);
				balle[last].body.drag.set(100);
				balle[last].angle = sprite.angle;
				
				game.physics.arcade.velocityFromRotation(balle[last].rotation, 700, balle[last].body.velocity);

				nbTir+=1;
			}

			function tuerBalle(){ //supprime la balle une fois qu'elle sort de l'écran
				for(var i = 0 ; i < balle.length ; i++){
					if(balle[i] != -1 && (balle[i].x > game.width || balle[i].x < 0 || balle[i].y > game.height || balle[i].y < 0 )){
						balle[i].kill();
						balle[i] = -1;
						//console.log(i + " supprimé");
					}else{
						//console.log("on est dans le else");
						for(var j = 0 ; j < ennemi.length ; j++){
							if(balle[i] != -1){
								//console.log("else balle");
								if(ennemi[j] != -1){
									//if(balle[i].x-10 > ennemi[j].x && balle[i].x-10 < ennemi[j].x+50 && balle[i].y > ennemi[j].y-50 && balle[i].y-10 < ennemi[j].y){								
									var vtex = balle[i].x - ennemi[j].x;
									var vtey = balle[i].y - ennemi[j].y;
									if(vtex*vtex + vtey*vtey < ((50/2 + 5)*(50/2 + 5))){
										balle[i].kill();
										balle[i] = -1;

										ennemi[j].kill();
										ennemi[j] = -1;
						
										nbEnnemi -= 1;
				
										//console.log(i + " balle, " + j + " ennemi.");
									}
								}
							}
						}
					}
				}
			}

			function mortJoueur(){ //si le joueur touche un ennemi, mort!
				for(var i = 0 ; i < ennemi.length ; i++){
					var vtex = ennemi[i].x-sprite.x;
					var vtey = ennemi[i].y-sprite.y;

					if(vtex*vtex + vtey*vtey < ((50/2 + 16)*(50/2 + 16))){
						game.add.sprite(0,0, 'over');
						//console.log("MORT!!!!"); // on affiche le fond
						move = false;
						game.time.events.add(Phaser.Timer.SECOND * 3, restart, this);
					}
				}
			}


			function restart(){
				location.reload(true);
			}
			//creation du parallax
			function initPara(){
				
				for(var i = 0; i < 75; i++){
					//var p_X = Math.floor((Math.random() * 800) + 1);
					//var p_Y = Math.floor((Math.random() * 600) + 1);
					parallaxback.push(game.add.sprite(Math.floor((Math.random() * 800) + 1),Math.floor((Math.random() * 600) + 1), 'back'));
					//parallaxback[i].anchor.set(0.5);
					parallaxmid.push(game.add.sprite(Math.floor((Math.random() * 800) + 1),Math.floor((Math.random() * 600) + 1), 'mid'));
					//parallaxmid[i].anchor.set(0.5);
					parallaxtop.push(game.add.sprite(Math.floor((Math.random() * 800) + 1),Math.floor((Math.random() * 600) + 1), 'top'));
					//parallaxtop[i].anchor.set(0.5);
				}
			}

			/*//deplacement des étoiles
			function deplacementPara(position){
				for(var i = 0; i < 100 ; i++){
					//var p_X = Math.floor((Math.random() * 800) + 1);
					//var p_Y = Math.floor((Math.random() * 600) + 1);
					//game.physics.arcade.velocityFromRotation(parallaxback[i].rotation, currentSpeed-2, parallaxback[i].body.velocity);
					//parallaxback[i].anchor.set(0.5);
					//game.physics.arcade.velocityFromRotation(parallaxmid[i].rotation, currentSpeed-1, parallaxmid[i].body.velocity);
					//parallaxmid[i].anchor.set(0.5);
					//game.physics.arcade.velocityFromRotation(parallaxtop[i].rotation, currentSpeed, parallaxtop[i].body.velocity);
					//parallaxtop[i].anchor.set(0.5);
					
					if(position == 1) // monte
					parallaxback[i].position.x += 1;
					parallaxmid[i]..position.x += 1;
					parallaxtop[i]..position.x += 1;

				}
			}*/


			function render(){
				//
			}
		</script>
</div>


	</body>


</html>
